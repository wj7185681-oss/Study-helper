<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Helper - V14.2 Global</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #5dade2; --secondary: #f39c12; --danger: #e74c3c; --success: #27ae60; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --border: #333; --input-bg: #2a2a2a; }
        body.light-mode { --bg: #f4f7f6; --card: #ffffff; --text: #2c3e50; --border: #ddd; --input-bg: #f9f9f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: auto; padding: 15px; transition: 0.3s; }
        .container { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .user-badge { font-size: 0.7rem; background: rgba(93, 173, 226, 0.1); color: var(--primary); padding: 4px 10px; border-radius: 20px; border: 1px solid var(--primary); }
        h1.main-title { text-align: center; font-size: 1.8rem; font-weight: 800; letter-spacing: 2px; margin: 15px 0 5px; color: var(--primary); text-shadow: 0 0 10px rgba(93,173,226,0.3); }
        h2 { border-left: 5px solid var(--primary); padding-left: 10px; font-size: 1.1rem; margin: 25px 0 10px; color: var(--primary); }
        .input-group { display: flex; gap: 8px; margin-bottom: 12px; }
        input, select { padding: 10px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); outline: none; flex: 1; }
        button { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        .timer-display { font-size: 3.5rem; font-family: monospace; font-weight: bold; margin: 10px 0; color: var(--primary); text-align: center; }
        .list-container { border: 1px solid var(--border); border-radius: 10px; background: rgba(0,0,0,0.1); margin-bottom: 15px; max-height: 250px; overflow-y: auto; }
        .item { padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }
        .goal-item { background: rgba(255,255,255,0.05); margin-bottom: 8px; padding: 10px; border-radius: 8px; border-left: 3px solid var(--secondary); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
        th, td { border: 1px solid var(--border); padding: 8px; text-align: center; }
        .sub-tag { display: flex; align-items: center; background: #333; color: #eee; border-radius: 20px; padding: 4px 12px; font-size: 0.8rem; cursor: pointer; margin: 4px; border: 1px solid transparent; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
        <span id="userTag" class="user-badge">ğŸ”‘ ID: ...</span>
        <div style="display:flex; gap:5px;">
            <button id="langBtn" onclick="toggleLang()" style="font-size:0.7rem; background:#444; color:#fff; padding:4px 8px;">ğŸŒ EN/TW</button>
            <button onclick="document.body.classList.toggle('light-mode')" style="font-size:0.7rem; background:#444; color:#fff; padding:4px 8px;">ğŸŒ“</button>
        </div>
    </div>

    <h1 class="main-title">Study Helper</h1>
    
    <div style="text-align:center; margin-bottom:10px;">
        <button onclick="promptID()" style="background:rgba(93,173,226,0.15); color:var(--primary); font-size:0.7rem; border:1px solid var(--primary); padding:4px 12px; border-radius:15px;">
            ğŸ”‘ <span id="txt_change_id">åˆ‡æ›ç©ºé–“ ID</span>
        </button>
    </div>

    <h2 id="title_exams">ğŸ“… è€ƒè©¦å€’æ•¸</h2>
    <div class="input-group">
        <input type="text" id="evName" placeholder="è€ƒè©¦åç¨±">
        <input type="date" id="evDate">
        <button style="background:var(--primary); color:#000" onclick="addEv()" id="btn_add_ev">æ–°å¢</button>
    </div>
    <div id="evList" class="list-container"></div>

    <h2 id="title_goals">ğŸ¯ é€±ç§‘ç›®ç›®æ¨™</h2>
    <div class="input-group">
        <select id="goalSubSelect"></select>
        <input type="number" id="goalHourInput" placeholder="å°æ™‚">
        <button style="background:var(--secondary); color:#fff" onclick="addGoal()" id="btn_set_goal">è¨­å®š</button>
    </div>
    <div id="goalList" class="list-container" style="max-height: 150px;"></div>

    <h2 id="title_timer">â±ï¸ å°ˆæ³¨è¨ˆæ™‚</h2>
    <div style="text-align:center; background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; border:1px solid var(--border);">
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button id="mStudy" style="flex:1; background:var(--primary); color:#000;" onclick="setMode('study')">æ™®é€šè¨ˆæ™‚</button>
            <button id="mPomo" style="flex:1; background:#444; color:#fff;" onclick="setMode('pomo')">ç•ªèŒ„é˜</button>
        </div>
        <div class="timer-display" id="tDisp">00:00:00</div>
        
        <div id="pomoSet" style="display:none; margin-bottom:10px; font-size:0.8rem;">
            <span id="txt_focus">å°ˆæ³¨</span> <input type="number" id="pMin" value="25" style="width:45px;" oninput="syncPomoInput()"> 
            <span id="txt_min">åˆ†</span> | 
            <span id="txt_rest">ä¼‘æ¯</span> <input type="number" id="rMin" value="5" style="width:45px;" oninput="syncPomoInput()"> 
            <span id="txt_min2">åˆ†</span>
        </div>

        <div id="subGroup" style="display:flex; flex-wrap:wrap; justify-content:center; margin-bottom:10px;"></div>
        <div class="input-group">
            <input type="text" id="newSubName" placeholder="æ–°å¢è‡ªè¨‚ç§‘ç›®...">
            <button onclick="addSub()" style="background:#555; color:white;">ï¼‹</button>
        </div>
        <div class="input-group">
            <input type="text" id="subj" value="è‡ªä¸»å­¸ç¿’" style="flex:1;">
            <button id="sBtn" onclick="toggleTimer()" style="background:var(--success); color:white; flex:1;">é–‹å§‹</button>
            <button onclick="manualSave()" style="background:var(--secondary); color:white; flex:1;" id="btn_save">å„²å­˜</button>
            <button onclick="resetTimer()" style="background:var(--danger); color:white; flex:1;" id="btn_reset">é‡è¨­</button>
        </div>
    </div>

    <h2 id="title_stats">ğŸ“ˆ æœ¬é€±æ•¸æ“šçµ±è¨ˆ</h2>
    <table>
        <thead><tr id="table_head"><th>ç§‘ç›®</th><th>æ™‚æ•¸</th><th>å æ¯”</th></tr></thead>
        <tbody id="statBody"></tbody>
    </table>

    <h2 id="title_logs">ğŸ“Š å­¸ç¿’ç´€éŒ„ (å…¨éƒ¨)</h2>
    <div id="logList" class="list-container"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAFgzkCDZLmrCQJ0h7NGl17S_d9joRZoPY",
        authDomain: "study-helper-d6815.firebaseapp.com",
        databaseURL: "https://study-helper-d6815-default-rtdb.firebaseio.com",
        projectId: "study-helper-d6815",
        storageBucket: "study-helper-d6815.firebasestorage.app",
        messagingSenderId: "908760745582",
        appId: "1:908760745582:web:2ead8ee0fdac19cd9f487f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const userID = new URLSearchParams(window.location.search).get('id') || "public_space";
    
    let state = { evs: [], logs: [], subs: [], goals: [], sec: 0, running: false, timer: null, mode: 'study', isRest: false, pomoInitialSec: 0, lang: 'tw' };

    const i18n = {
        tw: {
            title_exams: "ğŸ“… è€ƒè©¦å€’æ•¸", btn_add_ev: "æ–°å¢", ev_placeholder: "è€ƒè©¦åç¨±",
            title_goals: "ğŸ¯ é€±ç§‘ç›®ç›®æ¨™", btn_set_goal: "è¨­å®š", goal_hr_placeholder: "å°æ™‚",
            title_timer: "â±ï¸ å°ˆæ³¨è¨ˆæ™‚", mStudy: "æ™®é€šè¨ˆæ™‚", mPomo: "ç•ªèŒ„é˜",
            txt_focus: "å°ˆæ³¨", txt_rest: "ä¼‘æ¯", txt_min: "åˆ†", txt_min2: "åˆ†",
            btn_save: "å„²å­˜", btn_reset: "é‡è¨­", sBtn: "é–‹å§‹", sBtn_pause: "æš«åœ", sBtn_cont: "ç¹¼çºŒ",
            title_stats: "ğŸ“ˆ æœ¬é€±æ•¸æ“šçµ±è¨ˆ", table_head: "<th>ç§‘ç›®</th><th>æ™‚æ•¸</th><th>å æ¯”</th>",
            title_logs: "ğŸ“Š å­¸ç¿’ç´€éŒ„ (å…¨éƒ¨)", sub_placeholder: "æ–°å¢ç§‘ç›®...", subj_default: "è‡ªä¸»å­¸ç¿’",
            done: "å·²è®€", remain: "å‰©é¤˜", left: "å‰©", day: "å¤©", no_data: "å°šç„¡æ•¸æ“š",
            txt_change_id: "åˆ‡æ›ç©ºé–“ ID", prompt_id: "è«‹è¼¸å…¥æ‚¨çš„å°ˆå±¬ç©ºé–“ ID (è‹±æ–‡æˆ–æ•¸å­—):"
        },
        en: {
            title_exams: "ğŸ“… Exam Countdown", btn_add_ev: "Add", ev_placeholder: "Exam Name",
            title_goals: "ğŸ¯ Weekly Goals", btn_set_goal: "Set", goal_hr_placeholder: "Hrs",
            title_timer: "â±ï¸ Focus Timer", mStudy: "Stopwatch", mPomo: "Pomodoro",
            txt_focus: "Focus", txt_rest: "Rest", txt_min: "m", txt_min2: "m",
            btn_save: "Save", btn_reset: "Reset", sBtn: "Start", sBtn_pause: "Pause", sBtn_cont: "Resume",
            title_stats: "ğŸ“ˆ Weekly Stats", table_head: "<th>Subject</th><th>Time</th><th>%</th>",
            title_logs: "ğŸ“Š Study Logs (All)", sub_placeholder: "Add subject...", subj_default: "Self-study",
            done: "Done", remain: "Remain", left: "", day: "d left", no_data: "No data",
            txt_change_id: "Switch Space ID", prompt_id: "Enter your custom Space ID (letters/numbers):"
        }
    };

    function promptID() {
        const msg = i18n[state.lang].prompt_id;
        const newID = prompt(msg, userID);
        if (newID && newID !== userID) {
            window.location.href = window.location.pathname + '?id=' + encodeURIComponent(newID);
        }
    }

    function toggleLang() { state.lang = state.lang === 'tw' ? 'en' : 'tw'; render(); sync(); }

    function loadData() {
        db.ref('users_v14_2/' + userID).on('value', (snap) => {
            const data = snap.val();
            if (data) {
                state.evs = data.evs || []; state.logs = data.logs || []; state.subs = data.subs || []; 
                state.goals = data.goals || []; state.lang = data.lang || 'tw';
                render();
            } else { render(); }
        });
    }

    function sync() { db.ref('users_v14_2/' + userID).set(state); }

    function syncPomoInput() {
        if (state.running) return;
        const min = state.isRest ? document.getElementById('rMin').value : document.getElementById('pMin').value;
        state.pomoInitialSec = min * 60;
        state.sec = state.pomoInitialSec;
        updateDisplay();
    }

    function setMode(m) {
        if (state.running) return;
        state.mode = m;
        document.getElementById('mStudy').style.background = m === 'study' ? 'var(--primary)' : '#444';
        document.getElementById('mPomo').style.background = m === 'pomo' ? 'var(--primary)' : '#444';
        document.getElementById('pomoSet').style.display = m === 'pomo' ? 'block' : 'none';
        resetTimer();
    }

    function toggleTimer() {
        if (state.running) {
            clearInterval(state.timer); state.running = false;
            document.getElementById('sBtn').innerText = i18n[state.lang].sBtn_cont;
        } else {
            if (state