<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>è®€æ›¸åŠ©æ‰‹ - å¸³è™Ÿå®‰å…¨ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        :root { --primary: #5dade2; --secondary: #f39c12; --danger: #e74c3c; --success: #27ae60; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --border: #333; --input-bg: #2a2a2a; }
        body.light-mode { --bg: #f4f7f6; --card: #ffffff; --text: #2c3e50; --border: #ddd; --input-bg: #f9f9f9; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: auto; padding: 15px; }
        .container { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .auth-section { text-align: center; padding: 20px; border: 1px dashed var(--border); border-radius: 10px; margin-bottom: 20px; }
        .main-app { display: none; } /* æœªç™»å…¥æ™‚éš±è— */
        h2 { border-left: 5px solid var(--primary); padding-left: 10px; font-size: 1.1rem; margin: 25px 0 10px; color: var(--primary); }
        .input-group { display: flex; gap: 8px; margin-bottom: 12px; }
        input { padding: 10px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); flex: 1; outline: none; }
        button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .timer-display { font-size: 3.5rem; text-align: center; font-family: monospace; font-weight: bold; margin: 15px 0; color: var(--primary); }
        .list-container { border: 1px solid var(--border); border-radius: 10px; background: rgba(0,0,0,0.2); margin-bottom: 15px; }
        .item { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .tag { background: var(--primary); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div id="loginArea" class="auth-section">
        <h3>ğŸ”‘ è«‹ç™»å…¥ä»¥ä½¿ç”¨é›²ç«¯åŒæ­¥</h3>
        <button onclick="login()" style="background:#4285F4; color:white; width:100%;">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</button>
    </div>

    <div id="mainApp" class="main-app">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div id="userInfo" style="font-size:0.8rem; color:#888;">æ­£åœ¨è¼‰å…¥...</div>
            <button onclick="logout()" style="font-size:0.7rem; background:#444; color:#fff;">ç™»å‡º</button>
        </div>

        <h2>ğŸ“… è€ƒè©¦å€’æ•¸</h2>
        <div class="input-group">
            <input type="text" id="evName" placeholder="è€ƒè©¦åç¨±">
            <input type="date" id="evDate">
            <button style="background:var(--primary); color:#000" onclick="addEv()">æ–°å¢</button>
        </div>
        <div id="evList" class="list-container"></div>

        <h2>â±ï¸ å°ˆæ³¨è¨ˆæ™‚å™¨</h2>
        <div class="timer-display" id="tDisp">00:00:00</div>
        <div class="input-group">
            <input type="text" id="subj" value="è‡ªä¸»å­¸ç¿’">
            <button id="sBtn" onclick="toggleTimer()" style="background:var(--success); color:white; flex:2;">é–‹å§‹</button>
            <button onclick="manualSave()" style="background:var(--secondary); color:white; flex:1;">å„²å­˜</button>
        </div>
        <div id="logList" class="list-container"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAFgzkCDZLmrCQJ0h7NGl17S_d9joRZoPY",
        authDomain: "study-helper-d6815.firebaseapp.com",
        databaseURL: "https://study-helper-d6815-default-rtdb.firebaseio.com",
        projectId: "study-helper-d6815",
        storageBucket: "study-helper-d6815.firebasestorage.app",
        messagingSenderId: "908760745582",
        appId: "1:908760745582:web:2ead8ee0fdac19cd9f487f"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let state = { evs: [], logs: [], sec: 0, running: false, timer: null, user: null };

    // --- ç™»å…¥é‚è¼¯ ---
    function login() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider);
    }

    function logout() { auth.signOut(); location.reload(); }

    // ç›£è½ç™»å…¥ç‹€æ…‹
    auth.onAuthStateChanged(user => {
        if (user) {
            state.user = user;
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userInfo').innerText = "ğŸ‘¤ " + user.displayName;
            loadData();
        } else {
            document.getElementById('loginArea').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        }
    });

    // --- è³‡æ–™åŒæ­¥é‚è¼¯ (é‡å°å€‹äººè·¯å¾‘) ---
    function loadData() {
        // è³‡æ–™å„²å­˜è·¯å¾‘ï¼šusers/ä½ çš„UID/study_data
        db.ref('users/' + state.user.uid + '/study_data').on('value', snap => {
            const data = snap.val();
            if (data) {
                state.evs = data.evs || [];
                state.logs = data.logs || [];
                render();
            }
        });
    }

    function sync() {
        if (!state.user) return;
        db.ref('users/' + state.user.uid + '/study_data').set({
            evs: state.evs,
            logs: state.logs
        });
    }

    // --- ä»¥ä¸‹åŠŸèƒ½é‚è¼¯èˆ‡ V13 ç›¸åŒ ---
    function render() {
        const today = new Date().setHours(0,0,0,0);
        document.getElementById('evList').innerHTML = state.evs.map(ev => `
            <div class="item"><span>${ev.n}</span><span>å‰© ${Math.ceil((new Date(ev.d)-today)/86400000)}å¤© <span onclick="delEv(${ev.id})" style="cursor:pointer;color:red">âœ•</span></span></div>
        `).join('');
        document.getElementById('logList').innerHTML = state.logs.slice(0,5).map(l => `
            <div class="item"><span><span class="tag">${l.subject}</span> ${Math.floor(l.duration/60)}åˆ†</span></div>
        `).join('');
    }

    function addEv() {
        const n = document.getElementById('evName').value, d = document.getElementById('evDate').value;
        if(n && d) { state.evs.push({id:Date.now(), n, d}); sync(); }
    }
    function delEv(id) { state.evs = state.evs.filter(e => e.id !== id); sync(); }

    function toggleTimer() {
        if (state.running) {
            clearInterval(state.timer); state.running = false;
            document.getElementById('sBtn').innerText = "é–‹å§‹";
        } else {
            state.running = true;
            document.getElementById('sBtn').innerText = "æš«åœ";
            state.timer = setInterval(() => {
                state.sec++;
                document.getElementById('tDisp').innerText = new Date(state.sec * 1000).toISOString().substr(11, 8);
            }, 1000);
        }
    }

    function manualSave() {
        if(state.sec > 0) {
            state.logs.unshift({id:Date.now(), subject:document.getElementById('subj').value, duration:state.sec});
            state.sec = 0; clearInterval(state.timer); state.running = false;
            document.getElementById('tDisp').innerText = "00:00:00";
            document.getElementById('sBtn').innerText = "é–‹å§‹";
            sync();
        }
    }
</script>
</body>
</html>